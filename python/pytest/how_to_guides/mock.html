<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>How to monkeypatch/mock modules and environments | G-Tester</title>
    <meta name="description" content="Make Testing Automated And Intelligent">
    <link rel="preload stylesheet" href="/assets/style.541abdd5.css" as="style">
    <script type="module" src="/assets/app.fb46eba7.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
  <link rel="modulepreload" href="/assets/chunks/framework.b24ae0d9.js">
  <link rel="modulepreload" href="/assets/chunks/theme.914948fa.js">
  <link rel="modulepreload" href="/assets/python_pytest_how_to_guides_mock.md.d0cb7c43.lean.js">
  <link rel="icon" href="/favicon.ico">
  <script id="check-dark-light">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-7a06e6cf><!--[--><!--]--><!--[--><span tabindex="-1" data-v-13c8089c></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-13c8089c> Skip to content </a><!--]--><!----><header class="VPNav" data-v-7a06e6cf data-v-b6295a17><div class="VPNavBar has-sidebar" data-v-b6295a17 data-v-44478c57><div class="container" data-v-44478c57><div class="title" data-v-44478c57><div class="VPNavBarTitle has-sidebar" data-v-44478c57 data-v-9b008362><a class="title" href="/" data-v-9b008362><!--[--><!--]--><!--[--><img class="VPImage logo" src="/favicon.ico" alt data-v-dfc37153><!--]--><!--[-->G-Tester<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-44478c57><div class="curtain" data-v-44478c57></div><div class="content-body" data-v-44478c57><!--[--><!--]--><div class="VPNavBarSearch search" style="--vp-meta-key:&#39;Meta&#39;;" data-v-44478c57><!--[--><!----><div id="local-search"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20" aria-label="search icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-44478c57 data-v-ed1d2832><span id="main-nav-aria-label" class="visually-hidden" data-v-ed1d2832>Main Navigation</span><!--[--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-ed1d2832 data-v-bdcca533><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-bdcca533><span class="text" data-v-bdcca533><!----> Python <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-bdcca533><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-bdcca533><div class="VPMenu" data-v-bdcca533 data-v-78365eeb><div class="items" data-v-78365eeb><!--[--><!--[--><div class="VPMenuLink" data-v-78365eeb data-v-c3c0862f><a class="VPLink link" href="/python/doc/get_started" data-v-c3c0862f><!--[-->doc<!--]--></a></div><!--]--><!--[--><div class="VPMenuGroup" data-v-78365eeb data-v-03adb06b><p class="title" data-v-03adb06b>Test Automatic</p><!--[--><!--[--><div class="VPMenuLink" data-v-03adb06b data-v-c3c0862f><a class="VPLink link active" href="/python/pytest/get_started" data-v-c3c0862f><!--[-->pytest<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-03adb06b data-v-c3c0862f><a class="VPLink link" href="/..." data-v-c3c0862f><!--[-->selenium<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-03adb06b data-v-c3c0862f><a class="VPLink link" href="/..." data-v-c3c0862f><!--[-->requests<!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-78365eeb data-v-03adb06b><p class="title" data-v-03adb06b>Web Framework</p><!--[--><!--[--><div class="VPMenuLink" data-v-03adb06b data-v-c3c0862f><a class="VPLink link" href="/python/flask/index" data-v-c3c0862f><!--[-->flask<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-03adb06b data-v-c3c0862f><a class="VPLink link" href="/..." data-v-c3c0862f><!--[-->sql<!--]--></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-ed1d2832 data-v-bdcca533><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-bdcca533><span class="text" data-v-bdcca533><!----> Golang <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-bdcca533><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-bdcca533><div class="VPMenu" data-v-bdcca533 data-v-78365eeb><div class="items" data-v-78365eeb><!--[--><!--[--><div class="VPMenuLink" data-v-78365eeb data-v-c3c0862f><a class="VPLink link" href="/golang/doc/get_started" data-v-c3c0862f><!--[-->doc<!--]--></a></div><!--]--><!--[--><div class="VPMenuGroup" data-v-78365eeb data-v-03adb06b><p class="title" data-v-03adb06b>Web Framework</p><!--[--><!--[--><div class="VPMenuLink" data-v-03adb06b data-v-c3c0862f><a class="VPLink link" href="/golang/gin/get_started" data-v-c3c0862f><!--[-->gin<!--]--></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--[--><div class="VPFlyout VPNavBarMenuGroup" data-v-ed1d2832 data-v-bdcca533><button type="button" class="button" aria-haspopup="true" aria-expanded="false" data-v-bdcca533><span class="text" data-v-bdcca533><!----> Html <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-bdcca533><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-bdcca533><div class="VPMenu" data-v-bdcca533 data-v-78365eeb><div class="items" data-v-78365eeb><!--[--><!--[--><div class="VPMenuGroup" data-v-78365eeb data-v-03adb06b><p class="title" data-v-03adb06b>Traditional Framework</p><!--[--><!--[--><div class="VPMenuLink" data-v-03adb06b data-v-c3c0862f><a class="VPLink link" href="/layui/get_started" data-v-c3c0862f><!--[-->layui<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-03adb06b data-v-c3c0862f><a class="VPLink link" href="/..." data-v-c3c0862f><!--[-->Item B<!--]--></a></div><!--]--><!--]--></div><!--]--><!--[--><div class="VPMenuGroup" data-v-78365eeb data-v-03adb06b><p class="title" data-v-03adb06b>Awesome Framework</p><!--[--><!--[--><div class="VPMenuLink" data-v-03adb06b data-v-c3c0862f><a class="VPLink link" href="/vue3/index" data-v-c3c0862f><!--[-->vue3<!--]--></a></div><!--]--><!--[--><div class="VPMenuLink" data-v-03adb06b data-v-c3c0862f><a class="VPLink link" href="/..." data-v-c3c0862f><!--[-->vitepress<!--]--></a></div><!--]--><!--]--></div><!--]--><!--]--></div><!--[--><!--]--></div></div></div><!--]--><!--]--></nav><div class="VPFlyout VPNavBarTranslations translations" data-v-44478c57 data-v-2737067a data-v-bdcca533><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="Change language" data-v-bdcca533><span class="text" data-v-bdcca533><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="option-icon" data-v-bdcca533><path d="M0 0h24v24H0z" fill="none"></path><path d=" M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z " class="css-c4d79v"></path></svg>  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-bdcca533><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-bdcca533><div class="VPMenu" data-v-bdcca533 data-v-78365eeb><!----><!--[--><!--[--><div class="items" data-v-2737067a><p class="title" data-v-2737067a>English</p><!--[--><div class="VPMenuLink" data-v-2737067a data-v-c3c0862f><a class="VPLink link" href="/zh/python/pytest/how_to_guides/mock" data-v-c3c0862f><!--[-->简体中文 (待完成)<!--]--></a></div><!--]--></div><!--]--><!--]--></div></div></div><div class="VPNavBarAppearance appearance" data-v-44478c57 data-v-c4ed4958><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-c4ed4958 data-v-7cacad3f data-v-d34bc76a><span class="check" data-v-d34bc76a><span class="icon" data-v-d34bc76a><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-7cacad3f><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-7cacad3f><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-44478c57 data-v-a97a362c data-v-936e6304><!--[--><a class="VPSocialLink" href="https://github.com/huohuoren4/docs.git" aria-label="github" target="_blank" rel="noopener" data-v-936e6304 data-v-c394454b><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-44478c57 data-v-c00e8439 data-v-bdcca533><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-bdcca533><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-bdcca533><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-bdcca533><div class="VPMenu" data-v-bdcca533 data-v-78365eeb><!----><!--[--><!--[--><div class="group translations" data-v-c00e8439><p class="trans-title" data-v-c00e8439>English</p><!--[--><div class="VPMenuLink" data-v-c00e8439 data-v-c3c0862f><a class="VPLink link" href="/zh/python/pytest/how_to_guides/mock" data-v-c3c0862f><!--[-->简体中文 (待完成)<!--]--></a></div><!--]--></div><div class="group" data-v-c00e8439><div class="item appearance" data-v-c00e8439><p class="label" data-v-c00e8439>Appearance</p><div class="appearance-action" data-v-c00e8439><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-c00e8439 data-v-7cacad3f data-v-d34bc76a><span class="check" data-v-d34bc76a><span class="icon" data-v-d34bc76a><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-7cacad3f><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-7cacad3f><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-c00e8439><div class="item social-links" data-v-c00e8439><div class="VPSocialLinks social-links-list" data-v-c00e8439 data-v-936e6304><!--[--><a class="VPSocialLink" href="https://github.com/huohuoren4/docs.git" aria-label="github" target="_blank" rel="noopener" data-v-936e6304 data-v-c394454b><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-44478c57 data-v-1e17960c><span class="container" data-v-1e17960c><span class="top" data-v-1e17960c></span><span class="middle" data-v-1e17960c></span><span class="bottom" data-v-1e17960c></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav" data-v-7a06e6cf data-v-7ddd395a><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-7ddd395a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-7ddd395a><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-7ddd395a>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-7ddd395a data-v-e62f1730><button data-v-e62f1730>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-7a06e6cf data-v-0f64bd74><div class="curtain" data-v-0f64bd74></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-0f64bd74><span class="visually-hidden" id="sidebar-aria-label" data-v-0f64bd74> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-0f64bd74><section class="VPSidebarItem level-0 has-active" data-v-0f64bd74 data-v-dc29935d><div class="item" role="button" tabindex="0" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><h2 class="text" data-v-dc29935d>Pytest</h2><!----></div><div class="items" data-v-dc29935d><!--[--><div class="VPSidebarItem level-1 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/get_started" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>Get Started</p><!--]--></a><!----></div><!----></div><section class="VPSidebarItem level-1 collapsible has-active" data-v-dc29935d data-v-dc29935d><div class="item" role="button" tabindex="0" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><h3 class="text" data-v-dc29935d>How-to guides</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-dc29935d><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-dc29935d><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-dc29935d><!--[--><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/invoke_pytest" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to invoke pytest</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/assert" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to write and report assertions in tests</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/fixture" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to use fixtures</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/mark" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to mark test functions with attributes</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/params_fixture" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to parametrize fixtures and test functions</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/temp" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to use temporary directories and files in tests</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link is-active has-active" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/mock" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to monkeypatch/mock modules and environments</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/doctest" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to run doctests</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/re_run" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to re-run failed tests and maintain state between test runs</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/logging" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to manage logging</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/output" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to capture stdout/stderr output</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/warning" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to capture warnings</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/skip_xfail" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to use skip and xfail to deal with tests that cannot succeed</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/use_plugin" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to install and use plugins</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/write_plugin" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>Writing plugins</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/hook_func" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>Writing hook functions</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/test_suite" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to use pytest with an existing test suite</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/unittest" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to use unittest-based tests with pytest</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/nose_test" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to run tests written for nose</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/xunit" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to implement xunit-style set-up</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/how_to_guides/bash_completion" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to set up bash completion</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 collapsible collapsed" data-v-dc29935d data-v-dc29935d><div class="item" role="button" tabindex="0" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><h3 class="text" data-v-dc29935d>Reference guides</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-dc29935d><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-dc29935d><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-dc29935d><!--[--><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/reference_guides/fixture_reference" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>Fixtures reference</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/reference_guides/plugin_list" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>Plugin List</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/reference_guides/configuration" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>Configuration</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/reference_guides/api_reference" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>API Reference</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 collapsible collapsed" data-v-dc29935d data-v-dc29935d><div class="item" role="button" tabindex="0" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><h3 class="text" data-v-dc29935d>Explanation</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-dc29935d><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-dc29935d><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-dc29935d><!--[--><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/explanation/anatomy" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>Anatomy of a test</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/explanation/about_fixture" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>About fixtures</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/explanation/integration_practice" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>Good Integration Practices</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/explanation/flaky_test" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>Flaky tests</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/explanation/import_mechanism" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>pytest import mechanisms and sys.path/PYTHONPATH</p><!--]--></a><!----></div><!----></div><!--]--></div></section><section class="VPSidebarItem level-1 collapsible collapsed" data-v-dc29935d data-v-dc29935d><div class="item" role="button" tabindex="0" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><h3 class="text" data-v-dc29935d>Further topics</h3><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-dc29935d><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="caret-icon" data-v-dc29935d><path d="M9,19c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l5.3-5.3L8.3,6.7c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l6,6c0.4,0.4,0.4,1,0,1.4l-6,6C9.5,18.9,9.3,19,9,19z"></path></svg></div></div><div class="items" data-v-dc29935d><!--[--><div class="VPSidebarItem level-2 is-link" data-v-dc29935d data-v-dc29935d><div class="item" data-v-dc29935d><div class="indicator" data-v-dc29935d></div><a class="VPLink link link" href="/python/pytest/invoke_pytest" data-v-dc29935d><!--[--><p class="text" data-v-dc29935d>How to invoke pytest</p><!--]--></a><!----></div><!----></div><!--]--></div></section><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-7a06e6cf data-v-6b2142f5><div class="VPDoc has-sidebar has-aside" data-v-6b2142f5 data-v-cd59af2f><!--[--><!--]--><div class="container" data-v-cd59af2f><div class="aside" data-v-cd59af2f><div class="aside-curtain" data-v-cd59af2f></div><div class="aside-container" data-v-cd59af2f><div class="aside-content" data-v-cd59af2f><div class="VPDocAside" data-v-cd59af2f data-v-8375f399><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" data-v-8375f399 data-v-a67f17c2><div class="content" data-v-a67f17c2><div class="outline-marker" data-v-a67f17c2></div><div class="outline-title" data-v-a67f17c2>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-a67f17c2><span class="visually-hidden" id="doc-outline-aria-label" data-v-a67f17c2> Table of Contents for current page </span><ul class="root" data-v-a67f17c2 data-v-e5a44e96><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-8375f399></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-cd59af2f><div class="content-container" data-v-cd59af2f><!--[--><!--]--><!----><main class="main" data-v-cd59af2f><div style="position:relative;" class="vp-doc _python_pytest_how_to_guides_mock" data-v-cd59af2f><div><h1 id="how-to-monkeypatch-mock-modules-and-environments" tabindex="-1">How to monkeypatch/mock modules and environments <a class="header-anchor" href="#how-to-monkeypatch-mock-modules-and-environments" aria-label="Permalink to &quot;How to monkeypatch/mock modules and environments&quot;">​</a></h1><p>Sometimes tests need to invoke functionality which depends on global settings or which invokes code which cannot be easily tested such as network access. The <code>monkeypatch</code> fixture helps you to safely set/delete an attribute, dictionary item or environment variable, or to modify <code>sys.path</code> for importing.</p><p>The <code>monkeypatch</code> fixture provides these helper methods for safely patching and mocking functionality in tests:</p><ul><li>monkeypatch.setattr(obj, name, value, raising=True)</li><li>monkeypatch.delattr(obj, name, raising=True)</li><li>monkeypatch.setitem(mapping, name, value)</li><li>monkeypatch.delitem(obj, name, raising=True)</li><li>monkeypatch.setenv(name, value, prepend=None)</li><li>monkeypatch.delenv(name, raising=True)</li><li>monkeypatch.syspath_prepend(path)</li><li>monkeypatch.chdir(path)</li></ul><p>All modifications will be undone after the requesting test function or fixture has finished. The <code>raising</code> parameter determines if a <code>KeyError</code> or <code>AttributeError</code> will be raised if the target of the set/deletion operation does not exist.</p><p>Consider the following scenarios:</p><ol><li><p>Modifying the behavior of a function or the property of a class for a test e.g. there is an API call or database connection you will not make for a test but you know what the expected output should be. Use monkeypatch.setattr to patch the function or property with your desired testing behavior. This can include your own functions. Use monkeypatch.delattr to remove the function or property for the test.</p></li><li><p>Modifying the values of dictionaries e.g. you have a global configuration that you want to modify for certain test cases. Use monkeypatch.setitem to patch the dictionary for the test. monkeypatch.delitem can be used to remove items.</p></li><li><p>Modifying environment variables for a test e.g. to test program behavior if an environment variable is missing, or to set multiple values to a known variable. monkeypatch.setenv and monkeypatch.delenv can be used for these patches.</p></li><li><p>Use <code>monkeypatch.setenv(&quot;PATH&quot;, value, prepend=os.pathsep)</code> to modify <code>$PATH</code>, and monkeypatch.chdir to change the context of the current working directory during a test.</p></li><li><p>Use monkeypatch.syspath_prepend to modify <code>sys.path</code> which will also call <code>pkg_resources.fixup_namespace_packages</code> and importlib.invalidate_caches().</p></li><li><p>Use monkeypatch.context to apply patches only in a specific scope, which can help control teardown of complex fixtures or patches to the stdlib.</p></li></ol><p>See the monkeypatch blog post for some introduction material and a discussion of its motivation.</p><h2 id="monkeypatching-functions" tabindex="-1">Monkeypatching functions <a class="header-anchor" href="#monkeypatching-functions" aria-label="Permalink to &quot;Monkeypatching functions&quot;">​</a></h2><p>Consider a scenario where you are working with user directories. In the context of testing, you do not want your test to depend on the running user. <code>monkeypatch</code> can be used to patch functions dependent on the user to always return a specific value.</p><p>In this example, monkeypatch.setattr is used to patch <code>Path.home</code> so that the known testing path <code>Path(&quot;/abc&quot;)</code> is always used when the test is run. This removes any dependency on the running user for testing purposes. monkeypatch.setattr must be called before the function which will use the patched function is called. After the test function finishes the <code>Path.home</code> modification will be undone.</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># contents of test_module.py with source code and the test</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> pathlib </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> Path</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getssh</span><span style="color:#89DDFF;">():</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span><span style="color:#676E95;font-style:italic;">Simple function to return expanded homedir ssh path.</span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> Path</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">home</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">.ssh</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">test_getssh</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">monkeypatch</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># mocked return function to replace Path.home</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># always return &#39;/abc&#39;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mockreturn</span><span style="color:#89DDFF;">():</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Path</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/abc</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Application of the monkeypatch to replace Path.home</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># with the behavior of mockreturn defined above.</span></span>
<span class="line"><span style="color:#A6ACCD;">    monkeypatch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setattr</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">Path</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">home</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> mockreturn</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Calling getssh() will use mockreturn in place of Path.home</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># for this test with the monkeypatch.</span></span>
<span class="line"><span style="color:#A6ACCD;">    x </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">getssh</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">assert</span><span style="color:#A6ACCD;"> x </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">Path</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">/abc/.ssh</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span></code></pre></div><h2 id="monkeypatching-returned-objects-building-mock-classes" tabindex="-1">Monkeypatching returned objects: building mock classes <a class="header-anchor" href="#monkeypatching-returned-objects-building-mock-classes" aria-label="Permalink to &quot;Monkeypatching returned objects: building mock classes&quot;">​</a></h2><p>monkeypatch.setattr can be used in conjunction with classes to mock returned objects from functions instead of values. Imagine a simple function to take an API url and return the json response.</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># contents of app.py, a simple API retrieval example</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> requests</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_json</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">url</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span><span style="color:#676E95;font-style:italic;">Takes a URL, and returns the JSON.</span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    r </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> requests</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">url</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> r</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">json</span><span style="color:#89DDFF;">()</span></span></code></pre></div><p>We need to mock r, the returned response object for testing purposes. The mock of <code>r</code> needs a <code>.json()</code> method which returns a dictionary. This can be done in our test file by defining a class to represent <code>r</code>.</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># contents of test_app.py, a simple test for our API retrieval</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># import requests for the purposes of monkeypatching</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> requests</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># our app.py that includes the get_json() function</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># this is the previous code block example</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> app</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># custom class to be the mock return value</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># will override the requests.Response returned from requests.get</span></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MockResponse</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># mock json() method always returns a specific testing dictionary</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#FFCB6B;">staticmethod</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">json</span><span style="color:#89DDFF;">():</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">mock_key</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">mock_response</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">test_get_json</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">monkeypatch</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Any arguments may be passed and mock_get() will always return our</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># mocked object, which only has the .json() method.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mock_get</span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;font-style:italic;">args</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">**</span><span style="color:#A6ACCD;font-style:italic;">kwargs</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MockResponse</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># apply the monkeypatch for requests.get to mock_get</span></span>
<span class="line"><span style="color:#A6ACCD;">    monkeypatch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setattr</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">requests</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">get</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> mock_get</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># app.get_json, which contains requests.get, uses the monkeypatch</span></span>
<span class="line"><span style="color:#A6ACCD;">    result </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_json</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">https://fakeurl</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">assert</span><span style="color:#A6ACCD;"> result</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">mock_key</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">mock_response</span><span style="color:#89DDFF;">&quot;</span></span></code></pre></div><p><code>monkeypatch</code> applies the mock for <code>requests.get</code> with our <code>mock_get</code> function. The <code>mock_get</code> function returns an instance of the <code>MockResponse</code> class, which has a <code>json()</code> method defined to return a known testing dictionary and does not require any outside API connection.</p><p>You can build the <code>MockResponse</code> class with the appropriate degree of complexity for the scenario you are testing. For instance, it could include an ok property that always returns <code>True</code>, or return different values from the <code>json()</code> mocked method based on input strings.</p><p>This mock can be shared across tests using a <code>fixture</code>:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># contents of test_app.py, a simple test for our API retrieval</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> pytest</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> requests</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># app.py that includes the get_json() function</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> app</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># custom class to be the mock return value of requests.get()</span></span>
<span class="line"><span style="color:#C792EA;">class</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">MockResponse</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">@</span><span style="color:#FFCB6B;">staticmethod</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">json</span><span style="color:#89DDFF;">():</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">mock_key</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">mock_response</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># monkeypatched requests.get moved to a fixture</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">pytest</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">fixture</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mock_response</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">monkeypatch</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span><span style="color:#676E95;font-style:italic;">Requests.get() mocked to return {&#39;mock_key&#39;:&#39;mock_response&#39;}.</span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mock_get</span><span style="color:#89DDFF;">(*</span><span style="color:#A6ACCD;font-style:italic;">args</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">**</span><span style="color:#A6ACCD;font-style:italic;">kwargs</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">MockResponse</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    monkeypatch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setattr</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">requests</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">get</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> mock_get</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># notice our test uses the custom fixture instead of monkeypatch directly</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">test_get_json</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">mock_response</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    result </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_json</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">https://fakeurl</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">assert</span><span style="color:#A6ACCD;"> result</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">mock_key</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">mock_response</span><span style="color:#89DDFF;">&quot;</span></span></code></pre></div><p>Furthermore, if the mock was designed to be applied to all tests, the <code>fixture</code> could be moved to a <code>conftest.py</code> file and use the with <code>autouse=True</code> option.</p><h2 id="global-patch-example-preventing-requests-from-remote-operations" tabindex="-1">Global patch example: preventing “requests” from remote operations <a class="header-anchor" href="#global-patch-example-preventing-requests-from-remote-operations" aria-label="Permalink to &quot;Global patch example: preventing “requests” from remote operations&quot;">​</a></h2><p>If you want to prevent the “requests” library from performing http requests in all your tests, you can do:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># contents of conftest.py</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> pytest</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">pytest</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">fixture</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">autouse</span><span style="color:#89DDFF;">=True)</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">no_requests</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">monkeypatch</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span><span style="color:#676E95;font-style:italic;">Remove requests.sessions.Session.request for all tests.</span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    monkeypatch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">delattr</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">requests.sessions.Session.request</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span></code></pre></div><p>This autouse fixture will be executed for each test function and it will delete the method <code>request.session.Session.request</code> so that any attempts within tests to create http requests will fail.</p><div class="tip custom-block"><p class="custom-block-title">Note</p><p>Be advised that it is not recommended to patch builtin functions such as <code>open</code>, <code>compile</code>, etc., because it might break pytest’s internals. If that’s unavoidable, passing <code>--tb=native</code>, <code>--assert=plain</code> and <code>--capture=no</code> might help although there’s no guarantee.</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">::: tip Note</span></span>
<span class="line"><span style="color:#A6ACCD;">Mind that patching stdlib functions and some third-party libraries used by pytest might break pytest itself, therefore in those cases it is recommended to use MonkeyPatch.context() to limit the patching to the block you want tested:</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">```python</span></span>
<span class="line"><span style="color:#A6ACCD;">import functools</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span>
<span class="line"><span style="color:#A6ACCD;">def test_partial(monkeypatch):</span></span>
<span class="line"><span style="color:#A6ACCD;">    with monkeypatch.context() as m:</span></span>
<span class="line"><span style="color:#A6ACCD;">        m.setattr(functools, &quot;partial&quot;, 3)</span></span>
<span class="line"><span style="color:#A6ACCD;">        assert functools.partial == 3</span></span></code></pre></div><p>See issue #3290 for details.</p></div><h2 id="monkeypatching-environment-variables" tabindex="-1">Monkeypatching environment variables <a class="header-anchor" href="#monkeypatching-environment-variables" aria-label="Permalink to &quot;Monkeypatching environment variables&quot;">​</a></h2><p>If you are working with environment variables you often need to safely change the values or delete them from the system for testing purposes. <code>monkeypatch</code> provides a mechanism to do this using the <code>setenv</code> and <code>delenv</code> method. Our example code to test:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># contents of our original code file e.g. code.py</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> os</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_os_user_lower</span><span style="color:#89DDFF;">():</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span><span style="color:#676E95;font-style:italic;">Simple retrieval function.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">    Returns lowercase USER or raises OSError.</span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    username </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> os</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getenv</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">USER</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> username </span><span style="color:#89DDFF;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">None:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#89DDFF;font-style:italic;">raise</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">OSError</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">USER environment is not set.</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> username</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">lower</span><span style="color:#89DDFF;">()</span></span></code></pre></div><p>There are two potential paths. First, the <code>USER</code> environment variable is set to a value. Second, the <code>USER</code> environment variable does not exist. Using <code>monkeypatch</code> both paths can be safely tested without impacting the running environment:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># contents of our test file e.g. test_code.py</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> pytest</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">test_upper_to_lower</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">monkeypatch</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span><span style="color:#676E95;font-style:italic;">Set the USER env var to assert the behavior.</span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    monkeypatch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setenv</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">USER</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">TestingUser</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">assert</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_os_user_lower</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">testinguser</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">test_raise_exception</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">monkeypatch</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span><span style="color:#676E95;font-style:italic;">Remove the USER env var and assert OSError is raised.</span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    monkeypatch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">delenv</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">USER</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">raising</span><span style="color:#89DDFF;">=False)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">with</span><span style="color:#A6ACCD;"> pytest</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">raises</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">OSError</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        _ </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_os_user_lower</span><span style="color:#89DDFF;">()</span></span></code></pre></div><p>This behavior can be moved into <code>fixture</code> structures and shared across tests:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># contents of our test file e.g. test_code.py</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> pytest</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">pytest</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">fixture</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mock_env_user</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">monkeypatch</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    monkeypatch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setenv</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">USER</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">TestingUser</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">pytest</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">fixture</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mock_env_missing</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">monkeypatch</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    monkeypatch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">delenv</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">USER</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">raising</span><span style="color:#89DDFF;">=False)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># notice the tests reference the fixtures for mocks</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">test_upper_to_lower</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">mock_env_user</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">assert</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_os_user_lower</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">testinguser</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">test_raise_exception</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">mock_env_missing</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">with</span><span style="color:#A6ACCD;"> pytest</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">raises</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">OSError</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        _ </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">get_os_user_lower</span><span style="color:#89DDFF;">()</span></span></code></pre></div><h2 id="monkeypatching-dictionaries" tabindex="-1">Monkeypatching dictionaries <a class="header-anchor" href="#monkeypatching-dictionaries" aria-label="Permalink to &quot;Monkeypatching dictionaries&quot;">​</a></h2><p>monkeypatch.setitem can be used to safely set the values of dictionaries to specific values during tests. Take this simplified connection string example:</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># contents of app.py to generate a simple connection string</span></span>
<span class="line"><span style="color:#A6ACCD;">DEFAULT_CONFIG </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">user</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">user1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">database</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">db1</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">}</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">create_connection_string</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">config</span><span style="color:#89DDFF;">=None):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span><span style="color:#676E95;font-style:italic;">Creates a connection string from input or defaults.</span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    config </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> config </span><span style="color:#89DDFF;">or</span><span style="color:#A6ACCD;"> DEFAULT_CONFIG</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;User Id=</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">user</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">; Location=</span><span style="color:#F78C6C;">{</span><span style="color:#A6ACCD;">config</span><span style="color:#89DDFF;">[</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">database</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">]</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;">;&quot;</span></span></code></pre></div><p>For testing purposes we can patch the <code>DEFAULT_CONFIG</code> dictionary to specific values.</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># contents of test_app.py</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># app.py with the connection string function (prior code block)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> app</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">test_connection</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">monkeypatch</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Patch the values of DEFAULT_CONFIG to specific</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># testing values only for this test.</span></span>
<span class="line"><span style="color:#A6ACCD;">    monkeypatch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setitem</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">DEFAULT_CONFIG</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">user</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test_user</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    monkeypatch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setitem</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">DEFAULT_CONFIG</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">database</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test_db</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># expected result based on the mocks</span></span>
<span class="line"><span style="color:#A6ACCD;">    expected </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">User Id=test_user; Location=test_db;</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># the test uses the monkeypatched dictionary settings</span></span>
<span class="line"><span style="color:#A6ACCD;">    result </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">create_connection_string</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">assert</span><span style="color:#A6ACCD;"> result </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> expected</span></span></code></pre></div><p>You can use the monkeypatch.delitem to remove values.</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># contents of test_app.py</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> pytest</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># app.py with the connection string function</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> app</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">test_missing_user</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">monkeypatch</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># patch the DEFAULT_CONFIG t be missing the &#39;user&#39; key</span></span>
<span class="line"><span style="color:#A6ACCD;">    monkeypatch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">delitem</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">DEFAULT_CONFIG</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">user</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">raising</span><span style="color:#89DDFF;">=False)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># Key error expected because a config is not passed, and the</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># default is now missing the &#39;user&#39; entry.</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">with</span><span style="color:#A6ACCD;"> pytest</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">raises</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">KeyError</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        _ </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">create_connection_string</span><span style="color:#89DDFF;">()</span></span></code></pre></div><p>The modularity of fixtures gives you the flexibility to define separate fixtures for each potential mock and reference them in the needed tests.</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># contents of test_app.py</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> pytest</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># app.py with the connection string function</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> app</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># all of the mocks are moved into separated fixtures</span></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">pytest</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">fixture</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mock_test_user</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">monkeypatch</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span><span style="color:#676E95;font-style:italic;">Set the DEFAULT_CONFIG user to test_user.</span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    monkeypatch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setitem</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">DEFAULT_CONFIG</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">user</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test_user</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">pytest</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">fixture</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mock_test_database</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">monkeypatch</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span><span style="color:#676E95;font-style:italic;">Set the DEFAULT_CONFIG database to test_db.</span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    monkeypatch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">setitem</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">DEFAULT_CONFIG</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">database</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">test_db</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">@</span><span style="color:#82AAFF;">pytest</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">fixture</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">mock_missing_default_user</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">monkeypatch</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span><span style="color:#676E95;font-style:italic;">Remove the user key from DEFAULT_CONFIG</span><span style="color:#89DDFF;font-style:italic;">&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    monkeypatch</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">delitem</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">app</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">DEFAULT_CONFIG</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">user</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#A6ACCD;font-style:italic;">raising</span><span style="color:#89DDFF;">=False)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># tests reference only the fixture mocks that are needed</span></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">test_connection</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">mock_test_user</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">mock_test_database</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    expected </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">User Id=test_user; Location=test_db;</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    result </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">create_connection_string</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">assert</span><span style="color:#A6ACCD;"> result </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> expected</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">test_missing_user</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">mock_missing_default_user</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">with</span><span style="color:#A6ACCD;"> pytest</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">raises</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">KeyError</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">        _ </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> app</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">create_connection_string</span><span style="color:#89DDFF;">()</span></span></code></pre></div><h2 id="api-reference" tabindex="-1">API Reference <a class="header-anchor" href="#api-reference" aria-label="Permalink to &quot;API Reference&quot;">​</a></h2><p>Consult the docs for the MonkeyPatch class.</p></div></div></main><footer class="VPDocFooter" data-v-cd59af2f data-v-f16b59f2><!--[--><!--]--><!----><div class="prev-next" data-v-f16b59f2><div class="pager" data-v-f16b59f2><a class="pager-link prev" href="/python/pytest/how_to_guides/temp" data-v-f16b59f2><span class="desc" data-v-f16b59f2>Previous page</span><span class="title" data-v-f16b59f2>How to use temporary directories and files in tests</span></a></div><div class="has-prev pager" data-v-f16b59f2><a class="pager-link next" href="/python/pytest/how_to_guides/doctest" data-v-f16b59f2><span class="desc" data-v-f16b59f2>Next page</span><span class="title" data-v-f16b59f2>How to run doctests</span></a></div></div></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-7a06e6cf data-v-1ec3a3d7><div class="container" data-v-1ec3a3d7><p class="message" data-v-1ec3a3d7>Released under the MIT License.</p><p class="copyright" data-v-1ec3a3d7>Copyright © 2023-present G-Tester</p></div></footer><!--[--><!--]--></div></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"python_pytest_further_topics_enterprise.md\":\"be053bfe\",\"python_pytest_further_topics_contribution.md\":\"7d717b46\",\"python_pytest_further_topics_history.md\":\"ecd9dd7c\",\"python_pytest_further_topics_version_support.md\":\"325a9ac8\",\"readme.md\":\"011661a3\",\"python_pytest_how_to_guides_nose_test.md\":\"95e0bc99\",\"python_pytest_how_to_guides_output.md\":\"97bee2ab\",\"python_pytest_explanation_about_fixture.md\":\"94b8e8e0\",\"python_pytest_further_topics_example_trick.md\":\"7e837131\",\"python_pytest_explanation_flaky_test.md\":\"553eba7d\",\"python_pytest_further_topics_historical_note.md\":\"1f9b504c\",\"index.md\":\"83c89f71\",\"python_pytest_explanation_integration_practice.md\":\"b634a6ae\",\"python_pytest_further_topics_sponsor.md\":\"7702d348\",\"python_pytest_further_topics_development_guide.md\":\"7e732cc7\",\"python_pytest_further_topics_history_2.md\":\"13648226\",\"python_pytest_explanation_import_mechanism.md\":\"85785718\",\"python_pytest_how_to_guides_mark.md\":\"c34809c7\",\"python_pytest_further_topics_license.md\":\"85e5dcb8\",\"python_pytest_how_to_guides_bash_completion.md\":\"4f865983\",\"python_pytest_explanation_anatomy.md\":\"101f4610\",\"python_pytest_further_topics_talk_tutorial.md\":\"6a62b90f\",\"python_pytest_further_topics_announcement.md\":\"ce365fc5\",\"python_pytest_how_to_guides_test_suite.md\":\"b41b8d41\",\"python_pytest_further_topics_contact.md\":\"3965c02b\",\"python_pytest_how_to_guides_re_run.md\":\"4519a9f8\",\"python_pytest_how_to_guides_temp.md\":\"30979d5c\",\"python_flask_index.md\":\"41f4e195\",\"python_pytest_how_to_guides_use_plugin.md\":\"3865e889\",\"python_pytest_how_to_guides_invoke_pytest.md\":\"efd2a0f6\",\"python_pytest_how_to_guides_assert.md\":\"4cf3aa87\",\"python_pytest_get_started.md\":\"ac31fe70\",\"python_pytest_further_topics_compatibility.md\":\"00a1a85f\",\"python_pytest_how_to_guides_doctest.md\":\"0f7db9ed\",\"python_pytest_how_to_guides_hook_func.md\":\"a868593c\",\"python_pytest_how_to_guides_mock.md\":\"d0cb7c43\",\"python_pytest_how_to_guides_xunit.md\":\"4412cd81\",\"python_pytest_how_to_guides_warning.md\":\"0ecf3310\",\"python_pytest_how_to_guides_unittest.md\":\"63f5fc11\",\"python_pytest_how_to_guides_skip_xfail.md\":\"db7705a0\",\"python_pytest_how_to_guides_logging.md\":\"3b298dd7\",\"python_pytest_reference_guides_configuration.md\":\"411a1854\",\"python_pytest_how_to_guides_write_plugin.md\":\"03ed955b\",\"python_pytest_how_to_guides_params_fixture.md\":\"a456c55b\",\"python_pytest_reference_guides_fixture_reference.md\":\"616fb451\",\"python_pytest_reference_guides_plugin_list.md\":\"488aabe2\",\"python_pytest_how_to_guides_fixture.md\":\"294a1420\",\"python_pytest_reference_guides_api_reference.md\":\"fe3a02e2\"}")
__VP_SITE_DATA__ = JSON.parse("{\"lang\":\"en\",\"dir\":\"ltr\",\"title\":\"G-Tester\",\"description\":\"Make Testing Automated And Intelligent\",\"base\":\"/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"logo\":\"/favicon.ico\",\"nav\":[{\"text\":\"Python\",\"items\":[{\"text\":\"doc\",\"link\":\"/python/doc/get_started\",\"activeMatch\":\"/python/doc/\"},{\"text\":\"Test Automatic\",\"items\":[{\"text\":\"pytest\",\"link\":\"/python/pytest/get_started\",\"activeMatch\":\"/python/pytest\"},{\"text\":\"selenium\",\"link\":\"...\"},{\"text\":\"requests\",\"link\":\"...\"}]},{\"text\":\"Web Framework\",\"items\":[{\"text\":\"flask\",\"link\":\"/python/flask/index\",\"activeMatch\":\"/python/flask/\"},{\"text\":\"sql\",\"link\":\"...\"}]}]},{\"text\":\"Golang\",\"items\":[{\"text\":\"doc\",\"link\":\"/golang/doc/get_started\",\"activeMatch\":\"/golang/doc/\"},{\"text\":\"Web Framework\",\"items\":[{\"text\":\"gin\",\"link\":\"/golang/gin/get_started\",\"activeMatch\":\"/golang/gin/\"}]}]},{\"text\":\"Html\",\"items\":[{\"text\":\"Traditional Framework\",\"items\":[{\"text\":\"layui\",\"link\":\"/layui/get_started\",\"activeMatch\":\"/html/layui/\"},{\"text\":\"Item B\",\"link\":\"...\"}]},{\"text\":\"Awesome Framework\",\"items\":[{\"text\":\"vue3\",\"link\":\"/vue3/index\",\"activeMatch\":\"/html/vue3/\"},{\"text\":\"vitepress\",\"link\":\"...\"}]}]}],\"outline\":{\"level\":[2,3]},\"footer\":{\"message\":\"Released under the MIT License.\",\"copyright\":\"Copyright © 2023-present G-Tester\"},\"sidebar\":{\"/python/pytest/\":[{\"text\":\"Pytest\",\"items\":[{\"text\":\"Get Started\",\"link\":\"/python/pytest/get_started\"},{\"text\":\"How-to guides\",\"collapsed\":true,\"items\":[{\"text\":\"How to invoke pytest\",\"link\":\"/python/pytest/how_to_guides/invoke_pytest\"},{\"text\":\"How to write and report assertions in tests\",\"link\":\"/python/pytest/how_to_guides/assert\"},{\"text\":\"How to use fixtures\",\"link\":\"/python/pytest/how_to_guides/fixture\"},{\"text\":\"How to mark test functions with attributes\",\"link\":\"/python/pytest/how_to_guides/mark\"},{\"text\":\"How to parametrize fixtures and test functions\",\"link\":\"/python/pytest/how_to_guides/params_fixture\"},{\"text\":\"How to use temporary directories and files in tests\",\"link\":\"/python/pytest/how_to_guides/temp\"},{\"text\":\"How to monkeypatch/mock modules and environments\",\"link\":\"/python/pytest/how_to_guides/mock\"},{\"text\":\"How to run doctests\",\"link\":\"/python/pytest/how_to_guides/doctest\"},{\"text\":\"How to re-run failed tests and maintain state between test runs\",\"link\":\"/python/pytest/how_to_guides/re_run\"},{\"text\":\"How to manage logging\",\"link\":\"/python/pytest/how_to_guides/logging\"},{\"text\":\"How to capture stdout/stderr output\",\"link\":\"/python/pytest/how_to_guides/output\"},{\"text\":\"How to capture warnings\",\"link\":\"/python/pytest/how_to_guides/warning\"},{\"text\":\"How to use skip and xfail to deal with tests that cannot succeed\",\"link\":\"/python/pytest/how_to_guides/skip_xfail\"},{\"text\":\"How to install and use plugins\",\"link\":\"/python/pytest/how_to_guides/use_plugin\"},{\"text\":\"Writing plugins\",\"link\":\"/python/pytest/how_to_guides/write_plugin\"},{\"text\":\"Writing hook functions\",\"link\":\"/python/pytest/how_to_guides/hook_func\"},{\"text\":\"How to use pytest with an existing test suite\",\"link\":\"/python/pytest/how_to_guides/test_suite\"},{\"text\":\"How to use unittest-based tests with pytest\",\"link\":\"/python/pytest/how_to_guides/unittest\"},{\"text\":\"How to run tests written for nose\",\"link\":\"/python/pytest/how_to_guides/nose_test\"},{\"text\":\"How to implement xunit-style set-up\",\"link\":\"/python/pytest/how_to_guides/xunit\"},{\"text\":\"How to set up bash completion\",\"link\":\"/python/pytest/how_to_guides/bash_completion\"}]},{\"text\":\"Reference guides\",\"collapsed\":true,\"items\":[{\"text\":\"Fixtures reference\",\"link\":\"/python/pytest/reference_guides/fixture_reference\"},{\"text\":\"Plugin List\",\"link\":\"/python/pytest/reference_guides/plugin_list\"},{\"text\":\"Configuration\",\"link\":\"/python/pytest/reference_guides/configuration\"},{\"text\":\"API Reference\",\"link\":\"/python/pytest/reference_guides/api_reference\"}]},{\"text\":\"Explanation\",\"collapsed\":true,\"items\":[{\"text\":\"Anatomy of a test\",\"link\":\"/python/pytest/explanation/anatomy\"},{\"text\":\"About fixtures\",\"link\":\"/python/pytest/explanation/about_fixture\"},{\"text\":\"Good Integration Practices\",\"link\":\"/python/pytest/explanation/integration_practice\"},{\"text\":\"Flaky tests\",\"link\":\"/python/pytest/explanation/flaky_test\"},{\"text\":\"pytest import mechanisms and sys.path/PYTHONPATH\",\"link\":\"/python/pytest/explanation/import_mechanism\"}]},{\"text\":\"Further topics\",\"collapsed\":true,\"items\":[{\"text\":\"How to invoke pytest\",\"link\":\"/python/pytest/invoke_pytest\"}]}]}],\"/python/flask/\":[{\"text\":\"Flask\",\"items\":[{\"text\":\"Get Started\",\"link\":\"/python/flask/index\"}]}]},\"search\":{\"provider\":\"local\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/huohuoren4/docs.git\"}]},\"locales\":{\"root\":{\"label\":\"English\"},\"zh\":{\"label\":\"简体中文 (待完成)\",\"link\":\"\"}},\"scrollOffset\":90,\"cleanUrls\":true}")</script>
    
  </body>
</html>